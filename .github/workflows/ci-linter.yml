name: Go Lint

on:
  workflow_call:
    inputs:
      working-directory:
        description: 'Working directory'
        required: false
        default: '.'
        type: string
    secrets:
      GO_REPO_TOKEN:
        required: true
jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v5

      - name: Check out shared config repo
        uses: actions/checkout@v5
        with:
          repository: tech-scripter/linter
          token: ${{ secrets.GO_REPO_TOKEN }}
          path: .linter-config
          sparse-checkout: |
            golangci.yml

      - name: Copy config to root
        run: cp .linter-config/golangci.yml ./golangci.yml

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: false

      - name: Set up git for private modules
        run: |
          git config --global url."https://${{ secrets.GO_REPO_TOKEN }}:x-oauth-basic@github.com/".insteadOf "https://github.com/"

      - name: Download Go modules
        working-directory: ${{ inputs.working-directory }}
        run: go mod download

      - name: Run Linter
        uses: reviewdog/action-golangci-lint@v2
        with:
          level: info
          fail_level: error
          go_version_file: go.mod
          github_token: ${{ secrets.GO_REPO_TOKEN }}
          reporter: github-pr-review
          golangci_lint_flags: "--timeout 5m"
          workdir: ${{ inputs.working-directory }}
